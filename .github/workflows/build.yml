# Stardew Valley Cocos2d-x æž„å»ºå·¥ä½œæµ

name: Build Stardew Valley Cocos2d-x

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  # Windows æž„å»ºä»»åŠ¡
  windows-build:
    runs-on: windows-2022
    
    steps:
    # æ£€å‡ºä»£ç ï¼ˆåŒ…å«å­æ¨¡å—ï¼‰
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    # è®¾ç½® Miniconda çŽ¯å¢ƒï¼ˆå…¼å®¹ Python 2.7ï¼‰
    - name: è®¾ç½® Miniconda
      uses: conda-incubator/setup-miniconda@v2
      with:
        auto-update-conda: true
        python-version: '2.7'
        miniforge-version: latest
        activate-environment: cocos2dx-env
        
    # æ¿€æ´» conda çŽ¯å¢ƒå¹¶éªŒè¯ Python ç‰ˆæœ¬  
    - name: éªŒè¯ Python çŽ¯å¢ƒ
      shell: bash -l {0}
      run: |
        conda activate cocos2dx-env
        python --version
        python -c "import sys; print('Python path:', sys.executable)"
        
    # å®‰è£…å¿…è¦çš„ Python åŒ…
    - name: å®‰è£… Python ä¾èµ–
      shell: bash -l {0}
      run: |
        conda activate cocos2dx-env
        pip install requests
        
    # ä¸‹è½½ cocos2d-x ç¬¬ä¸‰æ–¹ä¾èµ–
    - name: ä¸‹è½½ cocos2d-x ä¾èµ–
      shell: bash -l {0}
      run: |
        conda activate cocos2dx-env
        cd cocos2d
        python download-deps.py --r no
        
    # è®¾ç½® Visual Studio çŽ¯å¢ƒ
    - name: è®¾ç½® Visual Studio å¼€å‘çŽ¯å¢ƒ
      uses: microsoft/setup-msbuild@v1.3
      with:
        vs-version: '17.0'
        
    # ç¼“å­˜ cocos2d-x ä¾èµ–
    - name: ç¼“å­˜ cocos2d-x ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          cocos2d/external/
          cocos2d/tools/
        key: ${{ runner.os }}-cocos2dx-deps-${{ hashFiles('cocos2d/download-deps.py') }}
        restore-keys: |
          ${{ runner.os }}-cocos2dx-deps-
        
    # åˆ›å»ºæž„å»ºç›®å½•
    - name: åˆ›å»ºæž„å»ºç›®å½•
      run: |
        mkdir build
        
    # é…ç½® CMake é¡¹ç›®
    - name: é…ç½® CMake
      run: |
        cd build
        cmake .. -G "Visual Studio 17 2022" -A Win32 -DCMAKE_BUILD_TYPE=Release
        
    # æž„å»ºé¡¹ç›®
    - name: æž„å»ºé¡¹ç›®
      run: |
        cd build
        cmake --build . --config Release --parallel 4
        
    # æ£€æŸ¥æž„å»ºç»“æžœ
    - name: æ£€æŸ¥æž„å»ºç»“æžœ
      run: |
        if (Test-Path "build\bin\Release\Stardew_Valley_Cocos2d-x4.0.exe") {
          Write-Host "âœ… æž„å»ºæˆåŠŸ! å¯æ‰§è¡Œæ–‡ä»¶å·²ç”Ÿæˆ"
          Get-ChildItem build\bin\Release\ -Recurse
        } else {
          Write-Host "âŒ æž„å»ºå¤±è´¥! æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          Get-ChildItem build\ -Recurse
          exit 1
        }
        
    # ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: windows-release-build
        path: |
          build/bin/Release/
          build/lib/Release/
          Resources/
        retention-days: 7
        
  # Windows Debug æž„å»ºä»»åŠ¡
  windows-debug-build:
    runs-on: windows-2022
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[debug]')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: è®¾ç½® Miniconda
      uses: conda-incubator/setup-miniconda@v2
      with:
        auto-update-conda: true
        python-version: '2.7'
        miniforge-version: latest
        activate-environment: cocos2dx-env
        
    - name: è®¾ç½® Visual Studio å¼€å‘çŽ¯å¢ƒ
      uses: microsoft/setup-msbuild@v1.3
      with:
        vs-version: '17.0'
        
    - name: ä¸‹è½½ cocos2d-x ä¾èµ–
      shell: bash -l {0}
      run: |
        conda activate cocos2dx-env
        cd cocos2d
        python download-deps.py --r no
        
    - name: åˆ›å»ºæž„å»ºç›®å½•
      run: mkdir build-debug
        
    - name: é…ç½® CMake (Debug)
      run: |
        cd build-debug
        cmake .. -G "Visual Studio 17 2022" -A Win32 -DCMAKE_BUILD_TYPE=Debug
        
    - name: æž„å»ºé¡¹ç›® (Debug)
      run: |
        cd build-debug
        cmake --build . --config Debug --parallel 4
        
    - name: ä¸Šä¼  Debug æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: windows-debug-build
        path: |
          build-debug/bin/Debug/
          build-debug/lib/Debug/
          Resources/
        retention-days: 7
        
  # æž„å»ºæŠ¥å‘Šä»»åŠ¡
  build-report:
    runs-on: ubuntu-latest
    needs: [windows-build]
    if: always()
    
    steps:
    - name: æž„å»ºç»“æžœæŠ¥å‘Š
      run: |
        echo "## ðŸŽ® Stardew Valley Cocos2d-x æž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| æž„å»ºä»»åŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows Release | ${{ needs.windows-build.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- Windows Release ç‰ˆæœ¬å·²ä¸Šä¼ ä¸ºæž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- åŒ…å«æ¸¸æˆå¯æ‰§è¡Œæ–‡ä»¶å’Œæ‰€éœ€çš„èµ„æºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ è¿è¡Œè¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½ windows-release-build æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "2. è§£åŽ‹åˆ°æœ¬åœ°ç›®å½•" >> $GITHUB_STEP_SUMMARY
        echo "3. è¿è¡Œ Stardew_Valley_Cocos2d-x4.0.exe" >> $GITHUB_STEP_SUMMARY
